<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
    {% extends 'shop/base.html' %}
    {% block title %}
        Pay by credit card
    {% endblock %}

    {% block content %}
        <h1>Pay by credit card</h1>
        <form id="payment" method="post">
            <label for="card-number">Card Number</label>
            <div id="card-number" class="field"><input type="number"></div>

            <label for="cvv">CVV</label>
            <div id="cvv" class="field"><input type="number"></div>

            <label for="expiration-date">Expiration Date</label>
            <div id="expiration-date" class="field"><input type="date"></div>

            <input type="hidden" id="nonce" name="payment_method_nonce" value="">
            <!--you will use to send the token nonce to your view once it is generated by the Braintree JavaScript client.-->
            {% csrf_token %}
            <input type="submit" value="Pay">
        </form>

        <!-- includes the Braintree JS client SDK -->
        <script src="https://js.braintreegateway.com/web/3.97.1/js/client.min.js">
        </script>
        <script src="https://js.braintreegateway.com/web/3.97.1/js/hosted-fields.min.js">
        </script>
        <script src="http://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
        <script>
            var form = document.querySelector('#payment');
            var submit = document.querySelector('input[type="submit"]');

        // instantiate the Braintree JavaScript client using the client_token generated by the payment_process view.
            braintree.client.create({
                authorization: '{{ client_token }}'
            }, function (clientErr, clientInstance){
                if (clientErr){
                    console.error(clientErr);
                    return;
                }

            // instantiate the Hosted Fields component with the braintree.hostedFields.create() method.
                braintree.hostedFields.create({
                client: clientInstance,
                styles: {
                    'input': {'font-size': '13px'},
                    'input.invalid': {'color': 'red'},
                    'input.valid': {'color': 'green'},
                },
                fields: {
                    number: {selector: '#card-number',
                        placeholder: '4111 1111 1111 1111'},

                    cvv: {selector: '#cvv',
                        placeholder: '123'},

                    expirationDate: {selector: '#expiration-date',
                        placeholder: '10/2024}
                }
            }, function (hostedFieldsErr, hostedFieldsInstance) {
                if (hostedFieldsErr) {
                console.error(hostedFieldsErr);
                return;
                }

                submit.removeAttribute('disabled');

                // to add an event listener for the submit action of the form;
                form.addEventListener('submit', function (event){
                    event.preventDefault();

                    hostedFieldsInstance.tokenize(function (tokenizeErr, payload)
                    {
                        if (tokenizeErr) {
                        console.error(tokenizeErr);
                        return;
                        }
                    // set nonce  to send to the server
                    document.getElementById('nonce').value = payload.nonce;

                    // submit form
                    document.getElementById('payment').submit();
                    });
                }, false);
            });
            });
        </script>
    {% endblock %}
</body>
</html>